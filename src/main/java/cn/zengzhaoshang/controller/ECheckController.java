package cn.zengzhaoshang.controller;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import cn.zengzhaoshang.dto.ECheckCount;
import cn.zengzhaoshang.dto.ECheckCustom;
import cn.zengzhaoshang.dto.ECheckQueryVo;
import cn.zengzhaoshang.dto.PageBean;
import cn.zengzhaoshang.entity.EDepart;
import cn.zengzhaoshang.exception.CustomException;
import cn.zengzhaoshang.service.ECheckService;
import cn.zengzhaoshang.service.EDepartService;
import cn.zengzhaoshang.util.WebUtils;

/**
 * 
 * @Title: EAccountController
 * @Description 考勤 控制层
 * @author zengzhaoshang
 * @date: 2019年3月28日 下午1:49:21  
 * @version v1.0
 * 注意：添加后不要回显添加时的数据，方便添加新数据； 修改要回显，方便修改和再次修改； 条件查找时要回显，方便确认是根据什么查找。
 */
@Controller
@RequestMapping("/check")
public class ECheckController {
	
	@Autowired
	private ECheckService eCheckService;
	
	@Autowired
	private EDepartService eDepartService;

	/**
	 * 进入添加考勤页面
	 */
	@RequestMapping("/entryAdd")
	public String entryAdd(Model model) throws Exception {
		model.addAttribute("checkDate", WebUtils.getLastMonth()); //回显，作为默认值，默认查询上个月
		return "check/addCheck";
	}
	
	/**
	 * 添加考勤后提交
	 */
	@RequestMapping(value="/submitAdd",method={RequestMethod.POST})
	public String submitAdd(String month, ECheckCustom eCheckCustom, Model model) throws Exception {
		String id = WebUtils.generateID();
		Date checkDate = new SimpleDateFormat("yyyy-MM").parse(month);
		eCheckCustom.setCheckDate(checkDate);
		model.addAttribute("checkDate", month);  //因为几乎都是添加同个月的考勤信息，所以回显同个月时间，方便下次添加。
		model.addAttribute("info", "操作提示：提交成功！");
		try {
			eCheckService.saveCheck(id, eCheckCustom);
		} catch (CustomException ce) {
			model.addAttribute("info", "操作提示：" + ce.getMessage());
		}
		return "check/addCheck";
	}
	
	/**
	 * 查看上个月考勤列表
	 */	
	@RequestMapping("/entryList")
	public String entryList(Model model, Integer pc) throws Exception {
		ECheckQueryVo eCheckQueryVo = new ECheckQueryVo(); //存储分页类和条件信息的包装类
		PageBean<ECheckCustom> pageBean = new PageBean<ECheckCustom>(); //分页类
		int ps = 16; //定义一页展示记录数
		if(pc == null) { //当前页码
			pc = 1;
		}
		pageBean.setPs(ps);
		pageBean.setPc(pc);
		eCheckQueryVo.setPageBean(pageBean);
		
		try {
			pageBean = eCheckService.findCheckListLast(eCheckQueryVo); //分页查找上个月的考勤信息
		} catch (CustomException ce) {
			model.addAttribute("info", "操作提示：" + ce.getMessage());
		}
		model.addAttribute("pageBean", pageBean);
		return "check/showCheckLast";
	}
	
	/**
	 * 进入条件查询页面
	 */
	@RequestMapping("/entryRequire")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
	public String entryRequire() throws Exception {
		return "check/showCheckByOne";
	}
	
	/**
	 * 提供部门信息   用于给按条件查询的页面 
	 * 通过返回值回显，显示到<select>标签
	 * @return
	 * @throws Exception 
	 */
	@ModelAttribute("departs")
	public Map<String,String> getDeparts() throws Exception{
		Map<String,String> departs = new LinkedHashMap<String,String>();
		List<EDepart> list = eDepartService.findDeparts();
		for(EDepart eDepart : list) {
			departs.put(eDepart.getId(),eDepart.getDeptName());
		}
		return departs;
	}
	
	/**
	 * 根据条件查看考勤列表
	 */
	@RequestMapping(value="/submitRequire",method={RequestMethod.GET})  //分页要用get，为了下一页能获取到查询条件，因为点下一页没法提交条件
	public String submitRequire(String month, ECheckCustom eCheckCustom, Model model, Integer pc, HttpServletRequest request) throws Exception {
		//回显信息
		model.addAttribute("month", month);
		model.addAttribute("eCheckCustom", eCheckCustom);
		//处理页面表单信息
		Date checkDate = null;  		   //日期类型格式转换前要判断
		if(month != null && month != "") { //如果为空，则不给转型，直接set为null
			checkDate = new SimpleDateFormat("yyyy-MM").parse(month);
		}
		eCheckCustom.setCheckDate(checkDate);
		//解决get方式乱码问题
		eCheckCustom.setJobNum(WebUtils.encoding(eCheckCustom.getJobNum()));;
		eCheckCustom.setStaffName(WebUtils.encoding(eCheckCustom.getStaffName()));
		eCheckCustom.setDeptName(WebUtils.encoding(eCheckCustom.getDeptName()));
		//分页处理
		ECheckQueryVo eCheckQueryVo = new ECheckQueryVo(); //存储分页类和条件信息的包装类
		PageBean<ECheckCustom> pageBean = new PageBean<ECheckCustom>(); //分页类
		int ps = 14; //定义一页展示记录数
		if(pc == null) { //当前页码
			pc = 1;
		}
		pageBean.setPs(ps);
		pageBean.setPc(pc);
		eCheckQueryVo.setPageBean(pageBean);
		eCheckQueryVo.seteCheckCustom(eCheckCustom);
		//开始根据条件进行查找
		try {
			pageBean = eCheckService.findCheckRequire(eCheckQueryVo); //带分页信息和条件进行查找
			pageBean.setUrl(getUrl(request)); //获取带有查询条件的url，在点击下一页的时候使用，可以不丢掉查询条件
			model.addAttribute("pageBean", pageBean);
		} catch (CustomException ce) {
			model.addAttribute("info", "操作提示：" + ce.getMessage());
		}
		return "check/showCheckByOne";
	}
	
	/**
	 * 进入上个月的统计效绩页面
	 */
	@RequestMapping("/entryCount")
	public String entryCount(Model model) throws Exception {
		model.addAttribute("month", WebUtils.getLastMonth());
		ECheckCount count = null;
		try {
			count = eCheckService.findCheckCount();
			String countDate = new SimpleDateFormat("yyyy年MM月").format(count.getCheckDate());
			model.addAttribute("countDate", countDate);
			model.addAttribute("count", count);
		} catch (CustomException ce) {
			model.addAttribute("info", "操作提示：" + ce.getMessage());
		}
		return "check/showCheckCount";
	}
	
	/**
	 * 查询某个月的统计效绩页面
	 */
	@RequestMapping(value="/submitCount",method={RequestMethod.POST})
	public String submitCount(Model model, String month) throws Exception {
		model.addAttribute("month", month);
		Date checkDate = new SimpleDateFormat("yyyy-MM").parse(month);
		try {
			ECheckCount count = eCheckService.findCheckCount(checkDate);
			String countDate = new SimpleDateFormat("yyyy年MM月").format(count.getCheckDate());
			model.addAttribute("countDate", countDate);
			model.addAttribute("count", count);
		} catch (CustomException ce) {
			model.addAttribute("info", "操作提示：" + ce.getMessage());
		}
		return "check/showCheckCount";
	}
	
	/**
	 * 查看某个考勤信息细节
	 */
	@RequestMapping("/entryDetail")
	public String entryDetail(String id, Model model) throws Exception {
		ECheckCustom eCheckCustom = eCheckService.findCheck(id);
		String month = new SimpleDateFormat("yyyy年MM月").format(eCheckCustom.getCheckDate());
		model.addAttribute("month", month);
		model.addAttribute("eCheckCustom", eCheckCustom);
		return "check/showCheckDetail";
	}
	
	/**
	 * 进入修改考勤页面
	 */
	@RequestMapping("/entryUpdate")
	public String entryUpdate(String id, Model model) throws Exception {
		ECheckCustom eCheckCustom = eCheckService.findCheck(id);
		String month = new SimpleDateFormat("yyyy-MM").format(eCheckCustom.getCheckDate());
		model.addAttribute("month", month);
		model.addAttribute("eCheckCustom", eCheckCustom);
		return "check/updateCheck";
	}
	
	/**
	 * 提交修改
	 */
	@RequestMapping(value="/submitUpdate",method={RequestMethod.POST})
	public String submitUpdate(String id, String month, ECheckCustom eCheckCustom, Model model) throws Exception {
		model.addAttribute("month", month);
		model.addAttribute("eCheckCustom", eCheckCustom);
		Date checkDate = new SimpleDateFormat("yyyy-MM").parse(month);
		eCheckCustom.setCheckDate(checkDate);
		model.addAttribute("info", "操作提示：修改成功！");
		try {
			eCheckService.updateCheck(id, eCheckCustom);
		} catch (CustomException ce) {
			model.addAttribute("info", "操作提示：" + ce.getMessage());
		}
		return "check/updateCheck";
	}
	
	/**
	 * 删除考勤
	 */
	@RequestMapping("/submitDelete")
	public String submitDelete(String id, Model model) throws Exception {
		model.addAttribute("info", "deleteSuccess");
		try {
			eCheckService.deleteCheck(id);
		} catch (CustomException ce) {
			model.addAttribute("info", "操作提示：" + ce.getMessage());
		}
		return entryList(model, 1);  //回到查询考勤列表
	}
	
	/**
	 * 保留原条件查询的url后缀
	 */
	private String getUrl(HttpServletRequest request){
		String contextPath = request.getContextPath(); //项目地址
		String servletPath = request.getServletPath(); //servlet地址
		String queryString = request.getQueryString(); //参数
		
		//去掉原来的pc，在页面重新加
		if(queryString.contains("&pc=")){
			int index = queryString.lastIndexOf("&pc=");
			queryString= queryString.substring(0,index);
		}
		return contextPath + servletPath + "?" +queryString;
	}
}
